package controllers;

import model.Bid;
import model.Job;
import model.Load;
import model.User;
import play.libs.Json;
import play.mvc.Controller;
import play.mvc.Result;

import java.util.ArrayList;
import java.util.List;

/**
 * Created with IntelliJ IDEA.
 * User: ericwood
 * Date: 8/24/13
 * Time: 7:10 AM
 * To change this template use File | Settings | File Templates.
 */
public class BidController extends Controller {

    public static Result getBids(String userId) {
        List<Bid> bids = new ArrayList<Bid>();
        Load load = new Load();
        load.setLoadDescription("a really big load");
        load.setCustomerId("customer@customer.com");

        Bid bid = new Bid();
        User biddingUser = new User();
        biddingUser.setUserId("bidder1@bid.com");
        biddingUser.setHaulerDisplayName("Bidder 1");
        bid.setBiddingUser(biddingUser);
        bid.setPrice(25.00);
        bid.setLoad(load);
        bids.add(bid);

        bid = new Bid();
        biddingUser = new User();
        biddingUser.setUserId("bidder2@bid.com");
        biddingUser.setHaulerDisplayName("Bidder 2");
        bid.setBiddingUser(biddingUser);
        bid.setPrice(15.00);
        bid.setLoad(load);
        bids.add(bid);

        bid = new Bid();
        biddingUser = new User();
        biddingUser.setUserId("bidder3@bid.com");
        biddingUser.setHaulerDisplayName("Bidder 3");
        bid.setBiddingUser(biddingUser);
        bid.setPrice(18.00);
        bid.setLoad(load);
        bids.add(bid);

        return ok(Json.toJson(bids));
    }

    public static Result createBid() {
        Bid newBid = Json.fromJson(request().body().asJson(),Bid.class);
        newBid.save();
        updateRating(newBid);
        return ok();
    }

    private static void updateRating(Bid newBid) {
        // Get jobs by haulerId
        User biddingUser = newBid.getBiddingUser();
        List<Job> jobs = Job.getJobs(biddingUser);

        // Compute the average rating
        int rating = 4;
        if (jobs.size() > 0) {
            int ratingSum = 0;
            for (Job job : jobs) {
                ratingSum += job.getRating();
            }
            double ratingAvg = ratingSum/jobs.size();
            rating = (int)Math.round(ratingAvg);
        }
        biddingUser.setHaulerRating(rating);
        biddingUser.save();
    }
}
